<!DOCTYPE html>
<html>
<head>
    <title>Cascading Security Scanner</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 2em; 
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 2em;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .error { 
            color: #d32f2f; 
            background-color: #ffebee;
            padding: 1em;
            border-radius: 4px;
            margin: 1em 0;
        }
        .success { 
            color: #388e3c; 
            background-color: #e8f5e8;
            padding: 1em;
            border-radius: 4px;
            margin: 1em 0;
        }
        .status { 
            margin-top: 1em; 
            padding: 1em;
            background-color: #e3f2fd;
            border-radius: 4px;
        }
        .form-group {
            margin-bottom: 1.5em;
        }
        .form-actions {
            display: flex;
            gap: 1em;
            align-items: center;
            flex-wrap: wrap;
        }
        label {
            display: block;
            margin-bottom: 0.5em;
            font-weight: bold;
            color: #333;
        }
        input[type="text"] {
            width: 100%;
            padding: 0.75em;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
            box-sizing: border-box;
        }
        input[type="text"]:focus {
            outline: none;
            border-color: #2196f3;
        }
        button {
            background-color: #2196f3;
            color: white;
            padding: 0.75em 1.5em;
            border: none;
            border-radius: 4px;
            font-size: 1em;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 0.5em;
            margin-bottom: 0.5em;
        }
        button:hover:not(:disabled) {
            background-color: #1976d2;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
        }
        .output {
            background-color: #f8f9fa;
            padding: 1em;
            border-radius: 4px;
            margin-top: 1em;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .output.error {
            background-color: #ffebee;
            color: #d32f2f;
        }
        .output.success {
            background-color: #e8f5e8;
            color: #388e3c;
        }
        .hidden {
            display: none;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .nav-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 2em;
        }
        .nav-tab {
            padding: 1em 2em;
            text-decoration: none;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        .nav-tab:hover {
            color: #2196f3;
            background-color: #f8f9fa;
        }
        .nav-tab.active {
            color: #2196f3;
            border-bottom-color: #2196f3;
            font-weight: bold;
        }
        .workflow-steps {
            display: flex;
            justify-content: space-between;
            margin: 2em 0;
            padding: 1em;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        .step {
            text-align: center;
            flex: 1;
            padding: 1em;
            margin: 0 0.5em;
            background: white;
            border-radius: 4px;
            border: 2px solid #ddd;
        }
        .step.active {
            border-color: #2196f3;
            background-color: #e3f2fd;
        }
        .step.completed {
            border-color: #28a745;
            background-color: #e8f5e8;
        }
    </style>
</head>
<body 
    data-has-results="{{ 'true' if results_dir else 'false' }}"
    data-scan-in-progress="{{ 'true' if scan_in_progress else 'false' }}"
    data-scan-name="{{ scan_name or '' }}"
    data-target="{{ target or '' }}"
    data-results-dir="{{ results_dir or '' }}">
    <div class="container">
        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <a href="/" class="nav-tab">üîç Individual Scanners</a>
            <a href="/cascading" class="nav-tab active">üîÑ Cascading Scanner</a>
        </div>

        <h1>üîÑ Cascading Security Scanner</h1>
        <p>Run a complete security scan workflow: Naabu ‚Üí TLSX ‚Üí ZAP ‚Üí Nuclei</p>
        
        <!-- Workflow Steps Visualization -->
        <div class="workflow-steps">
            <div class="step" id="step-naabu">
                <h4>üîç Naabu</h4>
                <p>Port Discovery<br>(1-65535)</p>
            </div>
            <div class="step" id="step-tlsx">
                <h4>üîí TLSX</h4>
                <p>TLS/SSL Analysis<br>on Open Ports</p>
            </div>
            <div class="step" id="step-zap">
                <h4>üï∑Ô∏è ZAP</h4>
                <p>Web Security Testing<br>on HTTPS Endpoints</p>
            </div>
            <div class="step" id="step-nuclei">
                <h4>üéØ Nuclei</h4>
                <p>Vulnerability Scanning<br>using Templates</p>
            </div>
        </div>
        
        <form method="post" action="/cascading-scan">
            <div class="form-group">
                <label for="target">Target IP Address or Domain:</label>
                <input type="text" name="target" id="target" value="{{ target or '' }}" 
                       placeholder="e.g., 192.168.1.1 or example.com" required {% if scan_in_progress %}disabled{% endif %}>
            </div>
            <div class="form-actions">
                <button type="submit" id="scan-btn" {% if scan_in_progress %}disabled{% endif %}>
                    {% if scan_in_progress %}üîÑ Scanning...{% else %}üöÄ Start Cascading Scan{% endif %}
                </button>
                <button type="button" class="btn-secondary" onclick="clearCascadingScan()">
                    üóëÔ∏è Clear Scan State
                </button>
                <button type="button" class="btn-secondary" onclick="resetCascadingScan()">
                    üîÑ Reset State
                </button>
            </div>
        </form>

    {% if error %}
        <div class="error">{{ error }}</div>
    {% endif %}
        
        {% if success %}
            <div class="success">{{ success }}</div>
        {% endif %}
        
        {% if scan_in_progress %}
        <div class="status">
                <span class="error">
                    <strong>‚ö†Ô∏è Cascading Scan in Progress</strong><br>
                    A cascading scan is currently running. You cannot start a new scan until this one completes.<br>
                    <button onclick="resetCascadingScan()" style="margin-top: 0.5em;">üîÑ Reset Scan State</button>
                    <button onclick="clearCascadingScan()" style="margin-top: 0.5em; margin-left: 0.5em;">üóëÔ∏è Clear Scan State</button>
                </span>
            </div>
        {% endif %}

        {% if script_stdout or script_stderr %}
        <div style="margin-top:1em;">
            <h3>Scan Output</h3>
            {% if script_stdout %}
                <div><b>Standard Output:</b></div>
                <div id="script-output" class="output success">{{ script_stdout }}</div>
            {% endif %}
            {% if script_stderr %}
                <div><b>Error Output:</b></div>
                <div class="output error">{{ script_stderr }}</div>
            {% endif %}
        </div>
        {% endif %}

        {% if scan_in_progress %}
        <div style="margin-top:1em;">
            <h3>üîÑ Real-Time Scan Output</h3>
            <div id="realtime-output" class="output success" style="max-height: 600px; overflow-y: auto; font-family: monospace; white-space: pre-wrap;">
                Starting cascading scan... Waiting for output...
            </div>
            <div style="margin-top: 1em;">
                <button class="btn-secondary" onclick="clearOutput()">Clear Output</button>
                <button class="btn-secondary" onclick="scrollToBottom()">Scroll to Bottom</button>
            </div>
        </div>
        {% endif %}

        <!-- Results Section -->
        <div id="results-section" style="margin-top: 2em; display: none;">
            <h3>üìä Scan Results</h3>
            <div id="results-content">
                <p>Scan completed! Results are available for download.</p>
                <div style="display: flex; gap: 1em; flex-wrap: wrap;">
                    <button class="btn-success" onclick="downloadNaabu()">üì• Download Naabu Results</button>
                    <button class="btn-success" onclick="downloadTlsx()">üì• Download TLSX Results</button>
                    <button class="btn-success" onclick="downloadZap()">üì• Download ZAP Results</button>
                    <button class="btn-success" onclick="downloadNuclei()">üì• Download Nuclei Results</button>
                </div>
            </div>
        </div>

        <div style="margin-top: 2em; padding-top: 1em; border-top: 1px solid #ddd;">
            <h3>About Cascading Scanner</h3>
            <p>This cascading scanner runs a comprehensive security assessment workflow:</p>
            <ol>
                <li><strong>Naabu</strong>: Discovers all open ports (1-65535) on the target</li>
                <li><strong>TLSX</strong>: Analyzes TLS/SSL certificates on discovered ports</li>
                <li><strong>ZAP</strong>: Performs web application security testing on HTTPS endpoints</li>
                <li><strong>Nuclei</strong>: Scans for known vulnerabilities using security templates</li>
            </ol>
            <p><small>All results are automatically saved to MinIO and can be downloaded individually or as complete scan packages.</small></p>
        </div>
    </div>

        <script>
        // Get data from HTML data attributes to avoid template syntax conflicts
        const scanData = {
            hasResultsDir: document.body.getAttribute('data-has-results') === 'true',
            hasScanInProgress: document.body.getAttribute('data-scan-in-progress') === 'true',
            scanName: document.body.getAttribute('data-scan-name') || '',
            target: document.body.getAttribute('data-target') || '',
            resultsDir: document.body.getAttribute('data-results-dir') || ''
        };
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (scanData.hasScanInProgress) {
                startRealTimeOutput();
                pollScanStatus();
            }
        });

        function clearCascadingScan() {
            if (confirm('Are you sure you want to clear the current cascading scan state? This will reset the interface and clean up temporary files.')) {
                fetch('/cascading-clear-scan')
                    .then(response => response.json())
                    .then(data => {
                        alert('Cascading scan state cleared successfully!');
                        window.location.reload();
                    })
                    .catch(error => {
                        alert('Error clearing cascading scan state: ' + error.message);
                    });
            }
        }

        function resetCascadingScan() {
            if (confirm('Reset the cascading scan state? This will allow you to start a new scan.')) {
                fetch('/cascading-reset')
                    .then(response => response.json())
                    .then(data => {
                        alert('Cascading scan state reset successfully!');
                        window.location.reload();
                    })
                    .catch(error => {
                        alert('Error resetting cascading scan state: ' + error.message);
                    });
            }
        }

        function startRealTimeOutput() {
            const outputDiv = document.getElementById('realtime-output');
            if (!outputDiv) return;

            const eventSource = new EventSource('/stream-output');
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    if (data.output) {
                        outputDiv.textContent += data.output + '\n';
                        scrollToBottom();
                        
                        // Update workflow steps based on output
                        updateWorkflowSteps(data.output);
                    }
                } catch (e) {
                    console.error('Error parsing SSE data:', e);
                }
            };

            eventSource.onerror = function(event) {
                console.error('SSE error:', event);
                eventSource.close();
            };
        }

        function updateWorkflowSteps(output) {
            // Update workflow steps based on scan progress
            if (output.includes('NAABU') || output.includes('naabu')) {
                document.getElementById('step-naabu').classList.add('active');
            }
            if (output.includes('TLSX') || output.includes('tlsx')) {
                document.getElementById('step-naabu').classList.remove('active');
                document.getElementById('step-naabu').classList.add('completed');
                document.getElementById('step-tlsx').classList.add('active');
            }
            if (output.includes('ZAP') || output.includes('zap')) {
                document.getElementById('step-tlsx').classList.remove('active');
                document.getElementById('step-tlsx').classList.add('completed');
                document.getElementById('step-zap').classList.add('active');
            }
            if (output.includes('NUCLEI') || output.includes('nuclei')) {
                document.getElementById('step-zap').classList.remove('active');
                document.getElementById('step-zap').classList.add('completed');
                document.getElementById('step-nuclei').classList.add('active');
            }
            if (output.includes('CASCADING SCAN WORKFLOW COMPLETE') || output.includes('All scans completed successfully')) {
                document.getElementById('step-nuclei').classList.remove('active');
                document.getElementById('step-nuclei').classList.add('completed');
                document.getElementById('results-section').style.display = 'block';
            }
        }

        function pollScanStatus() {
            const statusInterval = setInterval(function() {
                fetch('/scan-status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'completed' || data.status === 'failed') {
                            clearInterval(statusInterval);
                            // Reload page to show results
                            setTimeout(() => {
                                window.location.reload();
                            }, 2000);
                        }
                    })
                    .catch(error => {
                        console.error('Error polling scan status:', error);
                    });
            }, 5000); // Poll every 5 seconds
        }

        function clearOutput() {
            const outputDiv = document.getElementById('realtime-output');
            if (outputDiv) {
                outputDiv.textContent = 'Output cleared...\n';
            }
        }

        function scrollToBottom() {
            const outputDiv = document.getElementById('realtime-output');
            if (outputDiv) {
                outputDiv.scrollTop = outputDiv.scrollHeight;
            }
        }

        // Download functions
        function downloadNaabu() {
            window.location.href = '/download-naabu';
        }

        function downloadTlsx() {
            window.location.href = '/download-tlsx';
        }

        function downloadZap() {
            window.location.href = '/download-zap';
        }

        function downloadNuclei() {
            window.location.href = '/download-nuclei';
        }

        </script>
</body>
</html> 